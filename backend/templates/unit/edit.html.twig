{% extends 'base.html.twig' %}
{% block title %}Éditer {{ suite.name }}{% endblock %}
{% block body %}
<h1 class="mb-3">Éditer le test: {{ suite.name }}</h1>
{{ form_start(form) }}
  {{ form_row(form.name) }}
  {{ form_row(form.folder) }}
  <div class="mb-3">
    <label class="form-label d-flex align-items-center justify-content-between">
      <span>Définition des tests (JSON)</span>
      <button type="button" class="btn btn-sm btn-outline-primary" id="aiHttpBtn"><i class="bi bi-magic"></i> IA: proposer des tests</button>
    </label>
    {{ form_widget(form.testsJson) }}
  </div>
  <button class="btn btn-primary">Enregistrer</button>
  <a href="{{ path('unit_show', {id: suite.id}) }}" class="btn btn-secondary">Retour</a>
{{ form_end(form) }}
<div class="modal" tabindex="-1" id="aiHttpModal" style="display:none; background: rgba(0,0,0,0.35); position: fixed; inset: 0;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">IA: générer des tests HTTP</h5>
        <button type="button" class="btn-close" id="aiHttpClose"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Décrivez les endpoints à tester</label>
        <textarea id="aiHttpPrompt" class="form-control" rows="5" placeholder="Ex: Tester GET / renvoie 200 et contient 'Accueil'. Tester POST /api/login avec JSON {email, password} renvoie 200."></textarea>
        <div class="form-text">Incluez les chemins, méthodes et assertions attendues.</div>
        <div id="aiHttpError" class="text-danger small d-none mt-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="aiHttpCancel">Annuler</button>
        <button type="button" class="btn btn-primary" id="aiHttpGenerate">Générer</button>
      </div>
    </div>
  </div>
  </div>
<script>
  (function(){
    function $(id){ return document.getElementById(id); }
    var btn = $('aiHttpBtn'); if (!btn) return;
    var modal = $('aiHttpModal'); var closeBtn = $('aiHttpClose'); var cancelBtn = $('aiHttpCancel'); var genBtn = $('aiHttpGenerate');
    function show(){ modal.style.display = 'block'; }
    function hide(){ modal.style.display = 'none'; }
    btn.addEventListener('click', show);
    closeBtn.addEventListener('click', hide); cancelBtn.addEventListener('click', hide);
    genBtn.addEventListener('click', async function(){
      var ta = $('aiHttpPrompt'); var err = $('aiHttpError'); err.classList.add('d-none'); err.textContent = '';
      var prompt = (ta.value||'').trim(); if (!prompt) { err.textContent = 'Veuillez saisir un prompt'; err.classList.remove('d-none'); return; }
      genBtn.disabled = true; genBtn.textContent = 'Génération…';
      try {
        var resp = await fetch('/api/ai/generate-http-tests', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt }) });
        var data = await resp.json();
        if (!resp.ok || data.error) throw new Error(data.error || ('Erreur ' + resp.status));
        var tests = Array.isArray(data.tests) ? data.tests : [];
        var form = document.querySelector('form'); if (!form) return;
        var taJson = form.querySelector('textarea.unit-tests-editor'); if (!taJson) return;
        var host = taJson.previousElementSibling && taJson.previousElementSibling.previousElementSibling ? taJson.previousElementSibling.previousElementSibling : null;
        if (host && typeof host.__ubSetTests === 'function') { host.__ubSetTests(tests); }
        else { taJson.value = JSON.stringify(tests, null, 2); }
        hide();
      } catch(e){ err.textContent = e.message; err.classList.remove('d-none'); }
      finally { genBtn.disabled = false; genBtn.textContent = 'Générer'; }
    });
  })();
</script>
{% endblock %}
